set -g default-terminal "xterm-256color"
set -g terminal-overrides ',*:RGB'
# set -g default-command 'cd ~ && exec ${SHELL} -l'
# set -g default-working-directory ~

set -g automatic-rename on # for windows
set -g automatic-rename-format '#{b:pane_current_path}'
set -g renumber-windows on # eliminate slack indices after deleting windows
set -g base-index 1
bind 0 select-window -t :10 # navigate to 10th window by pressing 0

set-hook -g session-created "run-shell ~/.dotfiles/scripts/tmux-name-sessions.sh"
set-hook -g session-closed  "run-shell ~/.dotfiles/scripts/tmux-name-sessions.sh"
set-hook -g session-renamed "run-shell ~/.dotfiles/scripts/tmux-name-sessions.sh"
# set-hook -g session-renamed "run-shell 'echo \"hook triggered at $(date)\" >> ~/tmux-hook-test.log'"

# set-hook -g after-new-window 'if "[ #{window_panes} -eq 1 ]" "run-shell \"if [ ! -f /tmp/tmux_resurrect_restored ]; then tmux send-keys 'cd ~' Enter; fi\""'
# set-hook -g after-new-window 'if "[ #{window_panes} -eq 1 ]" "run-shell \"if [ ! -f /tmp/tmux_resurrect_restored ]; then tmux send-keys \"cd ~\" Enter; fi\""'
# set-hook -g after-new-window 'if "[ #{window_panes} -eq 1 ]" "send-keys \"cd ~\" \; send-keys Enter'
# set-hook -ug after-new-window
# bind c new-window -c ~


# Status Bar
# Update rate
set -g status-interval 1  
set-option -g status-position top
# Add battery to status bar
set -g status-right " %H:%M %a(%d-%b-%y) #(~/.dotfiles/scripts/battery-status)#(~/.dotfiles/scripts/battery-percentage)"
set -g status-bg black
set -g status-fg white

greyLight="#d8dee9"
greyMedium="#abb2bf"
greyDark="#3b4252"
greenSoft="#a3be8c"
blueMuted="#81a1c1"
cyanSoft="#88c0d0"

set -g window-status-format "#I:#W"
set -g pane-border-style "fg=${greyDark}"
set -g pane-active-border-style "fg=${greyMedium}"
set -g window-status-current-format "#[fg=${cyanSoft},bold]#[underscore]#I:#W#{?window_zoomed_flag,(Z),}"
set -g window-status-current-format "#{?window_zoomed_flag,#[fg=${greenSoft}]\[,}#[fg=${cyanSoft},bold]#[underscore]#I:#W#{?window_zoomed_flag,#[fg=${greenSoft}]\],}"
set -g cursor-colour "${blueMuted}"

# Make input delay shorter
set -sg escape-time 0


set -g history-limit 3000
set -g prompt-history-limit 3
set -g display-time 0
set -g mouse on
set -g set-clipboard off
set -g message-line 0

# Emulate scrolling by sending up and down keys if these commands are running in the pane
tmux_commands_with_legacy_scroll="nano less more man git bat glow"


#### key bindings ####
bind c new-window -c ~
unbind d
unbind C-b
unbind Escape
set -g prefix Escape
bind Escape send-prefix
set -g prefix2 C-b
bind C-b send-prefix
bind n run-shell 'OLD=$(tmux display-message -p "#{window_id}") && tmux new-window -c "#{pane_current_path}" && tmux kill-window -t "$OLD"'
bind Delete kill-session
bind S run-shell 'OLD_SESSION=$(tmux display-message -p "#S"); tmux command-prompt -p "Switch to session (killing current):" "switch-client -t \"%%\" ; run-shell \"tmux kill-session -t $OLD_SESSION\""'

bind . run-shell 'unset TMUX && tmux new-session -d -s "popup-#{session_id}" -c "$DOTFILES" && tmux display-popup -w 80% -h 80% -d "#{pane_current_path}" -E "tmux attach-session -t popup-#{session_id} \; set-option -t popup-#{session_id} destroy-unattached on"'

bind Enter run-shell 'unset TMUX && tmux new-session -d -s "popup-#{session_id}" -c "#{pane_current_path}" && tmux display-popup -w 80% -h 80% -d "#{pane_current_path}" -E "tmux attach-session -t popup-#{session_id} \; set-option -t popup-#{session_id} destroy-unattached on"'

bind w run-shell 'test -d "$CLONES/tmux/tmux.wiki" && { unset TMUX && tmux new-session -d -s "popup-#{session_id}" -c "$CLONES/tmux/tmux.wiki" && tmux display-popup -w 80% -h 80% -d "#{pane_current_path}" -E "tmux attach-session -t popup-#{session_id} \; set-option -t popup-#{session_id} destroy-unattached on"; } || tmux display "wiki not cloned"'

bind ? display-popup -w 80% -h 80% -E 'source ~/.dotfiles/aliases.zsh; tmp="$(tmux list-keys; tmux list-keys -N)"; echo "$tmp" | sort | sk -e'
bind ? display-popup -w 80% -h 80% -E "source ~/.dotfiles/aliases.zsh; tmp=\$(tmux list-keys; tmux list-keys -N); echo \"\$tmp\" | sort | sk -e"
bind ? display-popup -w 80% -h 80% -E 'source ~/.dotfiles/aliases.zsh; tmp="$(tmux list-keys; tmux list-keys -N)"; echo "$tmp" | sort | sk -e'
bind h display-popup -w 80% -h 80% -E "source ~/.dotfiles/aliases.zsh; tmp=\$(cat ~/.dotfiles/cache/history | sed 's/^$//g' | sed -E 's/^: [0-9]+:[0-9]+;//' | sk -e -m --tac | while IFS= read -r line; do echo \"\${line#*;}\"; done | perl -pe 's/\n/; /' | sed 's/; $//'); tmux send-keys -l -- \"\$tmp\""

# bind -T prefix ? list-keys -N

bind -T root WheelUpPane \
	if-shell -Ft= '#{?mouse_any_flag,1,#{pane_in_mode}}' \
		'send -Mt=' \
		'if-shell -t= "#{?alternate_on,true,false} || echo \"#{tmux_commands_with_legacy_scroll}\" | grep -q \"#{pane_current_command}\"" \
			"send -t= Up" "copy-mode -et="'

bind -T root WheelDownPane \
	if-shell -Ft = '#{?pane_in_mode,1,#{mouse_any_flag}}' \
		'send -Mt=' \
		'if-shell -t= "#{?alternate_on,true,false} || echo \"#{tmux_commands_with_legacy_scroll}\" | grep -q \"#{pane_current_command}\"" \
			"send -t= Down" "send -Mt="'



bind \` switch-client -t '{marked}'
bind C switch-client -t '{marked}'


# Window management

bind -n C-Right next-window
bind -n C-Left  select-window -t -1

bind k kill-window
bind "\\" split-window -hc "#{pane_current_path}"
bind - split-window -vc "#{pane_current_path}"
# bind Space last-window # toggle to previous window
bind o new-window

# Pane management
unbind x
unbind t
bind t new-window -c "#{pane_current_path}"
bind x kill-pane
bind j choose-window 'join-pane -h -s "%%"'
bind J choose-window 'join-pane -s "%%"'

# Save the current zoom state and zoom after switching panes
bind -r Left if-shell -F '#{window_zoomed_flag}' \
    'select-pane -L; resize-pane -Z' \
    'select-pane -L'
bind -r Down if-shell -F '#{window_zoomed_flag}' \
    'select-pane -D; resize-pane -Z' \
    'select-pane -D'
bind -r Up if-shell -F '#{window_zoomed_flag}' \
    'select-pane -U; resize-pane -Z' \
    'select-pane -U'
bind -r Right if-shell -F '#{window_zoomed_flag}' \
    'select-pane -R; resize-pane -Z' \
    'select-pane -R'

# Reload config file
bind r run-shell 'tmux source-file ~/.tmux.conf && tmux display "tmux conf reloaded!"'
# bind S-r send-keys -t '$'

# Quickly open a new window
bind N new-window

# Synchronize all panes in a window
bind y setw synchronize-panes

#### copy mode : vim ####
setw -g mode-keys vi

bind -n C-S-Left swap-window -d -t -1
bind -n C-S-Right swap-window -d -t +1

# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-processes 'hx'

#### Other examples:
#### set -g @plugin 'github_username/plugin_name'
#### set -g @plugin 'github_username/plugin_name#branch'
#### set -g @plugin 'git@github.com:user/plugin'
#### set -g @plugin 'git@bitbucket.com:user/plugin'

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
# run '~/gitclone/clones/tmux-plugins/tpm/tpm'
run '~/.tmux/plugins/tpm/tpm'
