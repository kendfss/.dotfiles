#!/bin/env zsh

## play some music via mpv

set -euo pipefail

    local verbose
    local shuffle
    local dirs=()
    local files=()
    local list=false
    local count=false
    
    while [ $# -gt 0 ]; do
        local arg="$1"
        case "$arg" in
            '-v'|'--verbose') verbose='-v' && shift ;;
            '-s'|'--shuffle') shuffle='--shuffle' && shift ;;
            '-c'|'--count') count=true && shift ;;
            '-l'|'--list') list=true && shift ;;
            *.(wav|mp3|flac|aac|m4a|ogg|opus|aiff|aif)) 
                files+=("$(realpath "$arg")") && shift ;;
            *) dirs+=("$(realpath "$arg")") && shift ;;
        esac
    done
    
    [[ $list == true ]] && exts ** && return
    
    if [ 0 = ${#files[@]} ] && [ 0 = ${#dirs[@]} ]; then
        dirs=(${(@s;:;)PLAYPATH})
    fi
    
    for dir in "${dirs[@]}"; do
        dir="$(realpath "$dir")"
        # Single find command for all files recursively
        while IFS= read -r -d '' file; do
            files+=("$file")
        done < <(find "$dir" -type f \( -iname "*.flac" -o -iname "*.mp3" -o -iname "*.m4a" -o -iname "*.ogg" -o -iname "*.opus" -o -iname "*.wav" -o -iname "*.aif" -o -iname "*.aiff" \) -print0 2>/dev/null)
    done
    
    [[ $count == true ]] && echo ${#files[@]} && return
    [ ${#files[@]} -eq 0 ] && echo no files found >&2 && return 1
    
    mpv $verbose --no-resume-playback --no-audio-display $shuffle -- "${files[@]}"

