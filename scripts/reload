#!/bin/env zsh

local all=false
{ [ "$1" = '-a' ] || [ "$1" = '--all' ]; } && all=true
if [ -n "$TMUX" ] && [ $all = true ]; then
	local session=$(tmux display-message -p '#S')
	while IFS= read -r pane; do
		local pid=$(tmux display-message -t "$pane" -p '#{pane_pid}')
		local child_cmd=$(ps -o cmd= $(ps --ppid "$pid" -o pid= 2>/dev/null) 2>/dev/null)
		if ! echo "$child_cmd" | grep -qiE 'weechat|hx|less|man|more|fzf|sk|vim|nano|yt-dlp|gallery-dl|youtube-dl|cleanup|dupes'; then
			tmux send-keys -t "$pane" -l 'exec $SHELL -l'
			tmux send-keys -t "$pane" Enter
			tmux send-keys -t "$pane" C-l
		fi
	done < <(tmux list-panes -t "$session" -a -F '#{session_name}:#{window_index}.#{pane_index}')
	return
fi
exec $SHELL -l
